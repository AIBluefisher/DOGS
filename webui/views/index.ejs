<%- include('partials/header', {
    title: 'Visualize 3D Models',
    description: 'Explore and interact with stunning 3D models'
}) %>

<!-- Hero Section -->
<section class="hero">
    <div class="hero-content">
        <h1>Visualize 3D Gaussian Splatting</h1>
        <p>Explore and interact with stunning 3D models rendered in real-time using the latest Gaussian Splatting technology</p>
        <% if (user) { %>
            <a href="/upload" class="btn btn-primary">
                <i class="fa fa-plus"></i> Upload Your Model
            </a>
        <% } else { %>
            <a href="/signup" class="btn btn-primary">
                <i class="fa fa-rocket"></i> Get Started Free
            </a>
        <% } %>
    </div>
</section>

<!-- Models Section -->
<section class="models-section">
    <div class="section-header">
        <h2 style="color: #111827;">Explore 3D Models</h2>
        <p style="color: #111827;">Browse through our collection of high-quality 3D Gaussian Splatting models</p>
    </div>

    <% if (models && models.length > 0) { %>
        <div class="models-grid">
            <% models.forEach((model, index) => { %>
                <% 
                    var model_name = '';
                    if (model.path) {
                        model_name = model.path.substring(model.path.lastIndexOf('/') + 1);
                    }
                    
                    // Format the date nicely
                    var displayDate = '';
                    if (model.date) {
                        try {
                            // If date is in YYYY-MM-DD format
                            const [year, month, day] = model.date.split('-');
                            const dateObj = new Date(year, month - 1, day);
                            displayDate = dateObj.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        } catch (e) {
                            // If date is already formatted or in another format
                            displayDate = model.date;
                        }
                    }
                %>
                <div class="model-card revealOnScroll" data-animation="fadeInUp" data-delay="<%= index * 100 %>">
                    <% if (model.thumb_image_path) { %>
                        <img src="<%= model.thumb_image_path %>" alt="<%= model.title || '3D Model' %>" class="card-image">
                    <% } else { %>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 200px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fa fa-cube" style="font-size: 3rem;"></i>
                        </div>
                    <% } %>
                    <div class="card-content">
                        <!-- Model Title (User entered) -->
                        <h3 class="card-title"><%= model.title || 'Untitled Model' %></h3>
                        
                        <!-- Upload Date and Metadata -->
                        <div class="card-meta" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
                            <% if (displayDate) { %>
                                <div class="card-date" style="display: flex; align-items: center; gap: 0.25rem; color: var(--text-secondary); font-size: 0.75rem;">
                                    <i class="fa fa-calendar" style="font-size: 0.7rem;"></i>
                                    <span><%= displayDate %></span>
                                </div>
                            <% } %>
                            
                            <% if (model.stars > 0) { %>
                                <div class="card-stars" style="display: flex; align-items: center; gap: 0.125rem;">
                                    <% for (let i = 0; i < 5; i++) { %>
                                        <% if (i < Math.floor(model.stars || 0)) { %>
                                            <i class="fa fa-star" style="color: #fbbf24; font-size: 0.7rem;"></i>
                                        <% } else { %>
                                            <i class="fa fa-star-o" style="color: #d1d5db; font-size: 0.7rem;"></i>
                                        <% } %>
                                    <% } %>
                                    <span style="margin-left: 0.125rem; color: var(--text-secondary); font-size: 0.7rem;">
                                        <%= model.stars || 0 %>
                                    </span>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Description -->
                        <% if (model.description) { %>
                            <p class="card-subtitle" style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.75rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 2.25rem;">
                                <%= model.description %>
                            </p>
                        <% } %>
                        
                        <!-- Actions -->
                        <div class="card-actions">
                            <% 
                                var model_name = '';
                                if (model.path) {
                                    // Extract just the filename from /splats/filename.splat
                                    model_name = model.path.substring(model.path.lastIndexOf('/') + 1);
                                }
                            %>
                            <a href="/viewer:<%= model_name %>" class="btn btn-primary btn-sm">
                                <i class="fa fa-eye"></i> View
                            </a>
                            <% if (user) { %>
                                <button class="btn btn-outline btn-sm like-btn" data-model-id="<%= model.id %>">
                                    <i class="fa fa-heart"></i> Like
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
        <!-- Pagination -->
        <% if (totalPages > 1) { %>
            <div class="pagination-container">
                <div class="pagination-controls">
                    <% if (page > 1) { %>
                        <a href="/?page=<%= page - 1 %>&pageSize=<%= pageSize %>" class="pagination-btn">
                            <i class="fa fa-chevron-left"></i> Previous
                        </a>
                    <% } else { %>
                        <button class="pagination-btn" disabled>
                            <i class="fa fa-chevron-left"></i> Previous
                        </button>
                    <% } %>

                    <span class="page-info">
                        Showing <%= startIndex + 1 %> - <%= endIndex %> of <%= totalModels %> models
                        (Page <%= page %> of <%= totalPages %>)
                    </span>

                    <% if (page < totalPages) { %>
                        <a href="/?page=<%= page + 1 %>&pageSize=<%= pageSize %>" class="pagination-btn">
                            Next <i class="fa fa-chevron-right"></i>
                        </a>
                    <% } else { %>
                        <button class="pagination-btn" disabled>
                            Next <i class="fa fa-chevron-right"></i>
                        </button>
                    <% } %>
                </div>

                <ul class="pagination">
                    <!-- First Page -->
                    <% if (page > 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="/?page=1&pageSize=<%= pageSize %>">1</a>
                        </li>
                    <% } %>

                    <!-- Ellipsis for skipped pages -->
                    <% if (page > 3) { %>
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    <% } %>

                    <!-- Previous Page -->
                    <% if (page > 2) { %>
                        <li class="page-item">
                            <a class="page-link" href="/?page=<%= page - 1 %>&pageSize=<%= pageSize %>"><%= page - 1 %></a>
                        </li>
                    <% } %>

                    <!-- Current Page -->
                    <li class="page-item active">
                        <span class="page-link"><%= page %></span>
                    </li>

                    <!-- Next Page -->
                    <% if (page < totalPages - 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="/?page=<%= page + 1 %>&pageSize=<%= pageSize %>"><%= page + 1 %></a>
                        </li>
                    <% } %>

                    <!-- Ellipsis for skipped pages -->
                    <% if (page < totalPages - 2) { %>
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    <% } %>

                    <!-- Last Page -->
                    <% if (page < totalPages) { %>
                        <li class="page-item">
                            <a class="page-link" href="/?page=<%= totalPages %>&pageSize=<%= pageSize %>"><%= totalPages %></a>
                        </li>
                    <% } %>
                </ul>
            </div>
        <% } %>
    <% } else { %>
        <div class="empty-state">
            <i class="fa fa-cube"></i>
            <h3>No Models Available</h3>
            <p>Be the first to upload a 3D model!</p>
            <% if (user) { %>
                <a href="/upload" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fa fa-upload"></i> Upload Your First Model
                </a>
            <% } else { %>
                <a href="/signup" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fa fa-user-plus"></i> Sign Up to Get Started
                </a>
            <% } %>
        </div>
    <% } %>
</section>

<%- include('partials/footer') %>

    <script src="./static/js/feather-icons"></script>
    <script src="./static/js/jquery.panelslider.min.js"></script>
    <script src="./static/js/modernizr.min.js"></script>

    <script>
        // Scroll animation
        $(document).ready(function() {
            $('.revealOnScroll').each(function() {
                var delay = $(this).data('delay') || 0;
                $(this).css('animation-delay', delay + 'ms');
            });

            // Smooth scroll
            $('a[href^="#"]').on('click', function(e) {
                e.preventDefault();
                var target = $(this.getAttribute('href'));
                if (target.length) {
                    $('html, body').animate({
                        scrollTop: target.offset().top - 80
                    }, 1000);
                }
            });

            // Like button functionality
            $('.btn-outline').on('click', function(e) {
                e.preventDefault();
                var $btn = $(this);
                if ($btn.hasClass('liked')) {
                    $btn.removeClass('liked');
                    $btn.html('<i class="fa fa-heart"></i> Like');
                    $btn.css('color', 'var(--primary-color)');
                } else {
                    $btn.addClass('liked');
                    $btn.html('<i class="fa fa-heart"></i> Liked');
                    $btn.css('color', '#ef4444');
                }
            });

        });
    </script>
