<%- include('partials/header', {
    title: 'Upload Model',
    description: 'Share your 3D Gaussian Splatting models with the community'
}) %>

<!-- Hero Section -->
<section class="hero">
    <div class="hero-content">
        <h1>Upload 3D Model</h1>
        <p>Share your 3D Gaussian Splatting models with the community</p>
    </div>
</section>

    <!-- Upload Container -->
    <div class="upload-container">
        <div class="upload-card">
            <div class="upload-header">
                <h2>Upload New Model</h2>
                <p>Select your 3D splat file and thumbnail image</p>
            </div>

            <form id="uploadForm" action="/upload/?_csrf=<%= csrfToken %>" method="post" enctype="multipart/form-data">
                <!-- File Upload Area -->
                <div class="upload-area" id="dropArea">
                    <div class="upload-icon">
                        <i class="fa fa-cloud-upload"></i>
                    </div>
                    <div class="upload-text">
                        <h3>Drag & Drop Files Here</h3>
                        <p>or click to browse files</p>
                        <div class="browse-btn" id="browseBtn">
                            Browse Files
                        </div>
                    </div>
                    <!-- Updated accept attribute for splat files -->
                    <input type="file" class="file-input" id="fileInput" name="files" multiple="multiple" accept=".splat,.ksplat,.ply,.png,.jpg,.jpeg">
                </div>

                <!-- Selected Files List -->
                <div class="file-list" id="fileList"></div>

                <!-- Model Information -->
                <div class="form-group">
                    <label class="form-label">Model Title *</label>
                    <input type="text" class="form-input" name="title" placeholder="Enter a descriptive title" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" name="description" placeholder="Describe your model (optional)"></textarea>
                </div>

                <!-- Requirements - Updated for splat files -->
                <div class="requirements">
                    <h3><i class="fa fa-info-circle"></i> Upload Requirements</h3>
                    <ul>
                        <li>Maximum file size: 500MB per file</li>
                        <li>Supported 3D formats: .splat, .ksplat, .ply</li>
                        <li>Supported image formats: .png, .jpg, .jpeg</li>
                        <li>Please upload both: 3D splat file and thumbnail image</li>
                        <li>Make sure the model is properly formatted for Gaussian Splatting</li>
                    </ul>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Uploading...</div>
                </div>

                <!-- Messages -->
                <div class="message" id="successMessage" style="border-radius: 0.75rem; margin: 1rem 0; display: None; animation: fadeIn 0.3s ease;">
                    <i class="fa fa-check-circle"></i> Upload successful! Redirecting...
                </div>

                <div class="message" id="errorMessage" style="border-radius: 0.75rem; margin: 1rem 0; display: None; animation: fadeIn 0.3s ease;">
                    <i class="fa fa-exclamation-circle"></i> <span id="errorText"></span>
                </div>

                <!-- Submit Button -->
                <div class="submit-section">
                    <button type="submit" class="btn btn-primary submit-btn" id="submitBtn">
                        <i class="fa fa-spinner spinner"></i>
                        Upload Model
                    </button>
                </div>
            </form>
        </div>
    </div>


<%- include('partials/footer') %>

<!-- Page-specific JavaScript can go here if needed -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');
            const dropArea = document.getElementById('dropArea');
            const fileList = document.getElementById('fileList');
            const uploadForm = document.getElementById('uploadForm');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');

            let selectedFiles = [];

            // Browse button click
            browseBtn.addEventListener('click', () => fileInput.click());

            // File input change
            fileInput.addEventListener('change', handleFiles);

            // Drag and drop
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('drag-over');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('drag-over');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                fileInput.files = e.dataTransfer.files;
                handleFiles();
            });

            // Handle selected files
            function handleFiles() {
                selectedFiles = Array.from(fileInput.files);
                updateFileList();
            }

            // Update file list display
            function updateFileList() {
                fileList.innerHTML = '';

                if (selectedFiles.length === 0) {
                    fileList.style.display = 'none';
                    return;
                }

                fileList.style.display = 'block';

                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';

                    const fileSize = formatFileSize(file.size);
                    const fileType = getFileType(file.name);

                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="fa ${fileType.icon}"></i>
                            </div>
                            <div class="file-details">
                                <h4>${file.name}</h4>
                                <p>${fileSize} â€¢ ${fileType.name}</p>
                            </div>
                        </div>
                        <button type="button" class="file-remove" data-index="${index}">
                            <i class="fa fa-times"></i>
                        </button>
                    `;

                    fileList.appendChild(fileItem);
                });

                // Add remove functionality
                document.querySelectorAll('.file-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        selectedFiles.splice(index, 1);
                        updateFileList();
                        
                        // Update the actual file input
                        const dataTransfer = new DataTransfer();
                        selectedFiles.forEach(file => dataTransfer.items.add(file));
                        fileInput.files = dataTransfer.files;
                    });
                });
            }

            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Get file type - Updated for splat files
            function getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                if (ext === 'splat' || ext === 'ksplat') {
                    return { name: '3D Splat', icon: 'fa-cube' };
                } else if (ext === 'ply') {
                    return { name: '3D Model', icon: 'fa-cube' };
                } else if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) {
                    return { name: 'Image', icon: 'fa-image' };
                } else {
                    return { name: 'File', icon: 'fa-file' };
                }
            }

            // Form submission
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Validate files
                if (selectedFiles.length === 0) {
                    showError('Please select at least one file');
                    return;
                }

                // Check file types - Updated for splat files
                const hasModel = selectedFiles.some(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['splat', 'ksplat', 'ply'].includes(ext);
                });
                
                const hasImage = selectedFiles.some(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext);
                });

                if (!hasModel) {
                    showError('Please include a 3D model file (.splat, .ksplat, or .ply)');
                    return;
                }

                if (!hasImage) {
                    showError('Please include a thumbnail image (.png, .jpg, .jpeg)');
                    return;
                }

                // Show progress and disable submit button
                progressContainer.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.classList.add('loading');
                hideMessages();

                try {
                    const formData = new FormData(uploadForm);
                    
                    // Simulate progress (remove this in production)
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += 10;
                        progressFill.style.width = `${progress}%`;
                        if (progress >= 90) clearInterval(progressInterval);
                    }, 200);

                    const response = await fetch(uploadForm.action, {
                        method: 'POST',
                        body: formData
                    });

                    clearInterval(progressInterval);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Upload failed' }));
                        throw new Error(errorData.message || 'Upload failed');
                    }

                    const data = await response.json();
                    
                    // Complete progress
                    progressFill.style.width = '100%';
                    progressText.textContent = 'Upload complete!';

                    // Show success message
                    showSuccess();

                    // Reset form after delay
                    setTimeout(() => {
                        uploadForm.reset();
                        selectedFiles = [];
                        updateFileList();
                        progressContainer.style.display = 'none';
                        progressFill.style.width = '0%';
                        progressText.textContent = 'Uploading...';
                        successMessage.style.display = 'none';
                        
                        // Redirect to home page
                        window.location.href = '/';
                    }, 2000);

                } catch (error) {
                    console.error('Upload error:', error);
                    showError(error.message || 'Upload failed. Please try again.');
                    progressContainer.style.display = 'none';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                }
            });

            // Message functions
            function showSuccess() {
                hideMessages();
                successMessage.style.display = 'block';
            }

            function showError(message) {
                hideMessages();
                errorText.textContent = message;
                errorMessage.style.display = 'block';
            }

            function hideMessages() {
                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';
            }

            // Initialize
            updateFileList();
        });
    </script>
